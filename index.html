<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factor BINGO Suite v4 (Sound Enabled)</title>
    <style>
        :root {
            --primary: #4a90e2;
            --secondary: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
            --bg: #f0f2f5;
            --cert-border: #d4af37;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--secondary);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- NAVIGATION & LAYOUT --- */
        .view-section {
            display: none;
            width: 100%;
            max-width: 800px;
            flex-direction: column;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .view-section.active { display: flex; }

        .btn {
            border: none;
            padding: 12px 20px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn:disabled { background-color: #ccc; color: #666; cursor: not-allowed; box-shadow: none; transform: none; }
        
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-warning { background-color: var(--warning); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--secondary); color: var(--secondary); }
        .btn-back { background: transparent; color: #7f8c8d; text-decoration: underline; font-size: 0.9rem; margin-top: 20px; border: none; box-shadow: none;}

        /* --- GAME BOARDS --- */
        .bingo-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            max-width: 450px;
        }

        .cell {
            aspect-ratio: 1;
            width: 60px;
            background-color: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }
        .cell:hover { border-color: var(--primary); background: #e8f4fd; }
        .cell.marked { background-color: var(--success); color: white; border-color: var(--success); box-shadow: inset 0 0 0 3px white; }
        .cell.wrong { background-color: var(--danger); color: white; animation: shake 0.4s; }
        .cell.locked { opacity: 0.6; cursor: not-allowed; }

        /* --- HISTORY LOGS --- */
        .history-container {
            width: 100%; max-width: 450px; background: white; padding: 10px;
            border-radius: 8px; margin-top: 10px; border: 1px solid #ddd;
        }
        .history-title { font-size: 0.9rem; font-weight: bold; color: #7f8c8d; border-bottom: 1px solid #eee; margin-bottom: 5px; padding-bottom: 5px;}
        .history-list { 
            display: flex; flex-wrap: wrap; gap: 5px; max-height: 80px; overflow-y: auto; 
            font-family: monospace; font-size: 1.1rem; color: var(--secondary);
        }
        .history-item { background: #eee; padding: 2px 6px; border-radius: 4px; }

        /* --- SINGLE PLAYER --- */
        .sp-controls {
            background: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .target-circle {
            width: 80px; height: 80px; background: var(--secondary); color: white; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-size: 2.5rem; margin: 10px auto;
            font-weight: 800;
        }

        /* --- TEACHER DASHBOARD --- */
        .teacher-box {
            background: white; padding: 30px; border-radius: 15px; text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); width: 100%; max-width: 600px;
            display: flex; flex-direction: column; align-items: center;
        }
        .big-display { font-size: 8rem; font-weight: 800; color: var(--secondary); margin: 10px 0; line-height: 1; }
        
        .mode-tabs { display: flex; gap: 10px; margin-bottom: 20px; background: #f0f2f5; padding: 5px; border-radius: 50px; }
        .mode-tab { padding: 8px 20px; border-radius: 40px; border: none; cursor: pointer; font-weight: bold; color: #7f8c8d; background: transparent; }
        .mode-tab.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .control-panel { width: 100%; border-top: 1px solid #eee; padding-top: 20px; margin-top: 10px;}
        .timer-settings { display: flex; gap: 10px; justify-content: center; align-items: center; margin-bottom: 15px; }
        select { padding: 8px; font-size: 1rem; border-radius: 5px; border: 1px solid #bdc3c7; }

        /* --- STUDENT PLAYER --- */
        .student-input-area {
            display: flex; gap: 10px; justify-content: center; align-items: center; margin-bottom: 10px; flex-wrap: wrap;
        }
        .student-input {
            font-size: 1.5rem; width: 80px; text-align: center; padding: 5px; border-radius: 8px; border: 2px solid #bdc3c7;
        }

        /* --- CERTIFICATE --- */
        .certificate-container {
            display: none; background: #fff; padding: 40px; border: 10px double var(--cert-border);
            text-align: center; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative;
        }
        .cert-header { font-family: 'Times New Roman', serif; font-size: 3rem; color: var(--cert-border); margin-bottom: 10px; }
        .cert-body { font-size: 1.2rem; margin: 20px 0; line-height: 1.6; }
        .cert-name { font-size: 2.5rem; font-family: 'Cursive', serif; border-bottom: 2px solid #333; display: inline-block; padding: 0 20px; margin: 10px 0; color: var(--secondary); }
        .cert-footer { margin-top: 30px; font-size: 0.9rem; color: #777; display: flex; justify-content: space-between; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 12px; text-align: center; max-width: 400px; width: 90%;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-box.large { max-width: 800px; } 
        
        .verify-grid {
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; max-height: 60vh; overflow-y: auto; padding: 10px;
        }
        .verify-item {
            font-size: 2rem; font-weight: bold; background: #eee; padding: 10px 20px; border-radius: 8px; color: var(--secondary);
            border: 2px solid #ddd;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); }}
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; }}
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(74, 144, 226, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(74, 144, 226, 0); } 100% { box-shadow: 0 0 0 0 rgba(74, 144, 226, 0); } }

        .pulsing { animation: pulse 1.5s infinite; }

    </style>
</head>
<body>

    <div id="menuView" class="view-section active" style="text-align:center; margin-top: 50px;">
        <h1 style="font-size: 3rem;">Factor BINGO</h1>
        <p style="font-size: 1.2rem; color: #555;">Select your game mode</p>
        
        <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
            <button class="btn btn-primary" style="width: 250px;" onclick="startSinglePlayer()">Single Player</button>
            <div style="width: 100px; height: 2px; background: #ddd; margin: 10px 0;"></div>
            <button class="btn btn-secondary" style="width: 250px;" onclick="showView('teacherView')">Classroom Host (Teacher)</button>
            <button class="btn btn-outline" style="width: 250px;" onclick="startStudentPlayer()">Classroom Player (Student)</button>
        </div>
    </div>

    <div id="spView" class="view-section">
        <h1>Single Player</h1>
        <div id="spGameArea">
            <div class="sp-controls">
                <div style="font-size: 0.9rem; font-weight: bold; color: #888;">TARGET NUMBER</div>
                <div id="spTarget" class="target-circle">--</div>
                <div>
                    <button id="spRollBtn" class="btn btn-primary" onclick="spRoll()">Roll Number</button>
                    <button id="spPassBtn" class="btn btn-warning" onclick="spPass()" disabled>No Factors (Pass)</button>
                </div>
                <div id="spFeedback" style="height: 25px; margin-top: 10px; font-weight: bold; color: var(--primary);">Click Roll to start</div>
            </div>
            <div id="spBoard" class="bingo-board"></div>
        </div>

        <div id="spCertificate" class="certificate-container">
            <div class="cert-header">Certificate of Mastery</div>
            <div class="cert-body">
                This certifies that
                <br>
                <div id="certNameDisplay" class="cert-name">Player Name</div>
                <br>
                has successfully demonstrated exceptional skills in identifying factors and conquering the grid.
            </div>
            <h3 style="color: var(--cert-border);">FACTOR BINGO CHAMPION</h3>
            <div class="cert-footer"><span id="certDate">Date: </span><span>Signature: ________________</span></div>
            <button class="btn btn-primary" style="margin-top:20px;" onclick="startSinglePlayer()">Play Again</button>
        </div>
        <button class="btn btn-back" onclick="showView('menuView')">Exit to Menu</button>
    </div>

    <div id="teacherView" class="view-section">
        <div class="teacher-box">
            <h2 style="margin:0; color:#7f8c8d;">PROJECTOR MODE</h2>
            <div id="teacherDisplay" class="big-display">--</div>

            <div class="mode-tabs">
                <button class="mode-tab active" id="tabManual" onclick="setTeacherMode('manual')">Manual</button>
                <button class="mode-tab" id="tabAuto" onclick="setTeacherMode('auto')">Automatic</button>
            </div>

            <div class="control-panel">
                <div id="manualControls">
                    <button class="btn btn-secondary" style="font-size: 1.3rem; padding: 10px 30px;" onclick="teacherRoll()">ROLL NUMBER</button>
                </div>

                <div id="autoControls" style="display:none;">
                    <div class="timer-settings">
                        <label style="font-weight:bold;">Interval:</label>
                        <select id="timerInterval">
                            <option value="15000">15 Seconds</option>
                            <option value="30000">30 Seconds</option>
                            <option value="60000">1 Minute</option>
                            <option value="120000">2 Minutes</option>
                        </select>
                    </div>
                    <button id="btnStartAuto" class="btn btn-success" onclick="startAutoRoll()">START AUTO</button>
                    <button id="btnStopAuto" class="btn btn-danger" onclick="stopAutoRoll()" disabled>STOP</button>
                    <div id="autoStatus" style="margin-top:5px; font-size: 0.9rem; color: #666; height: 1.2em;"></div>
                </div>
            </div>

            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; width: 100%;">
                <button class="btn btn-outline" style="width:100%;" onclick="openVerifyModal()">üîç Verify / Check Numbers</button>
            </div>
        </div>

        <div class="history-container" style="max-width: 600px;">
            <div class="history-title">SESSION HISTORY (Small View)</div>
            <div id="teacherHistory" class="history-list"></div>
        </div>
        <button class="btn btn-back" onclick="stopAutoRoll(); showView('menuView')">Exit Session</button>
    </div>

    <div id="studentView" class="view-section">
        <h1>Classroom Player</h1>
        <div class="sp-controls" style="padding: 15px;">
            <p style="margin: 0 0 10px 0; font-size: 0.9rem;">1. Wait for Teacher. 2. Enter Number. 3. Select Factor OR Pass.</p>
            <div class="student-input-area">
                <input type="number" id="mpInput" class="student-input" placeholder="#">
                <button id="mpConfirmBtn" class="btn btn-secondary" onclick="mpConfirmNumber()">Confirm Number</button>
            </div>
            <div style="margin-bottom: 10px;">
                <button id="mpPassBtn" class="btn btn-warning" onclick="mpPass()" disabled>I can't find a factor (Pass)</button>
            </div>
            <div id="mpFeedback" style="font-weight: bold; min-height: 1.2em;">Waiting for input...</div>
        </div>
        <div id="mpBoard" class="bingo-board"></div>
        <div class="history-container">
            <div class="history-title">YOUR ENTERED NUMBERS (Evidence)</div>
            <div id="studentHistory" class="history-list"></div>
        </div>
        <button class="btn btn-back" onclick="showView('menuView')">Exit Session</button>
    </div>

    <div id="spWinModal" class="modal-overlay">
        <div class="modal-box">
            <h2 style="font-size:3rem; margin:10px 0;">BINGO!</h2>
            <p>You found all the factors!</p>
            <button class="btn btn-primary" onclick="closeModal('spWinModal'); startSinglePlayer();">Play Again</button>
            <button class="btn btn-success" onclick="openCertInput()">Claim Certificate</button>
        </div>
    </div>

    <div id="certInputModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Claim Certificate</h3>
            <p>Enter your name:</p>
            <input type="text" id="playerNameInput" placeholder="Your Name" maxlength="20">
            <br>
            <button class="btn btn-success" onclick="generateCertificate()">Print / View</button>
            <button class="btn btn-outline" onclick="closeModal('certInputModal')">Cancel</button>
        </div>
    </div>

    <div id="mpWinModal" class="modal-overlay">
        <div class="modal-box">
            <h2 style="font-size:3rem; margin:10px 0;">BINGO!</h2>
            <p>Raise your hand!</p>
            <p style="font-size:0.9rem; color:#666;">Leave this screen open so your teacher can check your history log.</p>
            <button class="btn btn-secondary" onclick="closeModal('mpWinModal')">Close</button>
        </div>
    </div>

    <div id="verifyModal" class="modal-overlay">
        <div class="modal-box large">
            <h2>Called Numbers</h2>
            <p style="color:#666; margin-bottom: 20px;">Check the student's winning numbers against this list.</p>
            <div id="verifyGrid" class="verify-grid">
                </div>
            <button class="btn btn-secondary" style="margin-top: 20px;" onclick="closeModal('verifyModal')">Close</button>
        </div>
    </div>

    <script>
        // --- SOUND ENGINE (Base64) ---
        // Simple 'Win' Chime
        const winSoundData = "data:audio/wav;base64,UklGRjQBAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YREBAACAgICAgICAgICAgICAgICAgICAf39/f39/f39/f39/f39/f39/gYGDg4SFhYaGh4iIiYqLi4yNjY6OkJCSkpOUlZaXmJmam5ycnZ6en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/wABAgMEBQYHCAkKCwwNDg8QERITFBUWFxgZGhscHR4fICEiIyQlJicoKSorLC0uLzAxMjM0NTY3ODk6Ozw9Pj9AQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVpbXF1eX2BhYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ent8fX5/gIGCg4SFhoeIiYqLjI2Oj5CRkpOUlZaXmJmam5ycnZ6en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w=="; 
        // Note: The string above is a very short placeholder. 
        // To keep the file small and functional, I will use an oscillator based sound instead of a large MP3 string.
        
        function playWinSound() {
            // Using Web Audio API to generate a sound without external files or massive Base64 strings
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if(!AudioContext) return;
            
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            osc.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            // Arcade "Ding Ding Ding" Effect
            osc.type = 'square';
            osc.frequency.setValueAtTime(523.25, ctx.currentTime); // C5
            osc.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1); // E5
            osc.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2); // G5
            osc.frequency.setValueAtTime(1046.50, ctx.currentTime + 0.3); // C6
            
            gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.8);

            osc.start();
            osc.stop(ctx.currentTime + 0.8);
        }

        // --- UTILITIES ---
        function showView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        function createBoardData() { return shuffle(Array.from({length: 25}, (_, i) => i + 1)); }
        function checkWin(indices) {
            const wins = [
                [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24], 
                [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], 
                [0,6,12,18,24], [4,8,12,16,20]
            ];
            return wins.some(combo => combo.every(i => indices.has(i)));
        }

        // ================= SINGLE PLAYER =================
        let spState = { numbers: [], marked: new Set(), target: null, rolling: false };

        function startSinglePlayer() {
            document.getElementById('spGameArea').style.display = 'block';
            document.getElementById('spCertificate').style.display = 'none';
            document.getElementById('spTarget').innerText = "--";
            document.getElementById('spFeedback').innerText = "Click Roll to start";
            document.getElementById('spRollBtn').disabled = false;
            document.getElementById('spPassBtn').disabled = true;
            
            spState.marked.clear();
            spState.target = null;
            spState.rolling = false;
            spState.numbers = createBoardData();

            const board = document.getElementById('spBoard');
            board.innerHTML = '';
            spState.numbers.forEach((num, idx) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.innerText = num;
                cell.onclick = () => handleSpClick(idx, num, cell);
                board.appendChild(cell);
            });
            showView('spView');
        }

        function spRoll() {
            if (spState.rolling) return;
            spState.rolling = true;
            document.getElementById('spRollBtn').disabled = true;
            document.getElementById('spPassBtn').disabled = true;
            const disp = document.getElementById('spTarget');
            let count = 0;
            const interval = setInterval(() => {
                disp.innerText = Math.floor(Math.random() * 100) + 1;
                count++;
                if(count > 10) {
                    clearInterval(interval);
                    const finalNum = Math.floor(Math.random() * 100) + 1;
                    disp.innerText = finalNum;
                    spState.target = finalNum;
                    spState.rolling = false;
                    document.getElementById('spRollBtn').disabled = true;
                    document.getElementById('spPassBtn').disabled = false;
                    document.getElementById('spFeedback').innerHTML = `Find a factor of ${finalNum} OR Pass!`;
                }
            }, 50);
        }

        function spPass() {
            spState.target = null;
            document.getElementById('spRollBtn').disabled = false;
            document.getElementById('spPassBtn').disabled = true;
            document.getElementById('spTarget').innerText = "--";
            document.getElementById('spFeedback').innerText = "Turn skipped. Roll again.";
        }

        function handleSpClick(idx, val, el) {
            if(spState.rolling || !spState.target) return;
            if(spState.marked.has(idx)) return;
            if(spState.target % val === 0) {
                spState.marked.add(idx);
                el.classList.add('marked');
                document.getElementById('spFeedback').innerHTML = `<span style="color:green">Correct!</span> ${spState.target} √∑ ${val} = ${spState.target/val}`;
                spState.target = null;
                document.getElementById('spRollBtn').disabled = false;
                document.getElementById('spPassBtn').disabled = true;
                if(checkWin(spState.marked)) {
                    playWinSound(); // PLAY SOUND
                    setTimeout(() => document.getElementById('spWinModal').style.display = 'flex', 500);
                }
            } else {
                el.classList.add('wrong');
                document.getElementById('spFeedback').innerHTML = `<span style="color:red">Try again!</span>`;
                setTimeout(() => el.classList.remove('wrong'), 500);
            }
        }

        function openCertInput() { closeModal('spWinModal'); document.getElementById('certInputModal').style.display = 'flex'; }
        function generateCertificate() {
            const name = document.getElementById('playerNameInput').value || "Student";
            closeModal('certInputModal');
            document.getElementById('spGameArea').style.display = 'none';
            document.getElementById('spCertificate').style.display = 'block';
            document.getElementById('certNameDisplay').innerText = name;
            document.getElementById('certDate').innerText = "Date: " + new Date().toLocaleDateString();
        }

        // ================= TEACHER HOST =================
        let teacherState = { history: [], timerId: null, isAuto: false };

        function setTeacherMode(mode) {
            stopAutoRoll();
            document.getElementById('tabManual').classList.remove('active');
            document.getElementById('tabAuto').classList.remove('active');
            document.getElementById('manualControls').style.display = 'none';
            document.getElementById('autoControls').style.display = 'none';

            if(mode === 'manual') {
                document.getElementById('tabManual').classList.add('active');
                document.getElementById('manualControls').style.display = 'block';
                teacherState.isAuto = false;
            } else {
                document.getElementById('tabAuto').classList.add('active');
                document.getElementById('autoControls').style.display = 'block';
                teacherState.isAuto = true;
            }
        }

        function teacherRoll() {
            const disp = document.getElementById('teacherDisplay');
            let count = 0;
            const interval = setInterval(() => {
                disp.innerText = Math.floor(Math.random() * 100) + 1;
                count++;
                if(count > 10) {
                    clearInterval(interval);
                    const finalNum = Math.floor(Math.random() * 100) + 1;
                    disp.innerText = finalNum;
                    teacherState.history.push(finalNum);
                    addToHistory('teacherHistory', finalNum);
                }
            }, 50);
        }

        function startAutoRoll() {
            if(teacherState.timerId) return;
            const ms = parseInt(document.getElementById('timerInterval').value);
            document.getElementById('btnStartAuto').disabled = true;
            document.getElementById('btnStopAuto').disabled = false;
            document.getElementById('timerInterval').disabled = true;
            document.getElementById('autoStatus').innerText = "Game running...";
            document.getElementById('teacherDisplay').classList.add('pulsing');
            
            teacherRoll(); // Roll immediate first one
            teacherState.timerId = setInterval(teacherRoll, ms);
        }

        function stopAutoRoll() {
            if(teacherState.timerId) {
                clearInterval(teacherState.timerId);
                teacherState.timerId = null;
            }
            document.getElementById('btnStartAuto').disabled = false;
            document.getElementById('btnStopAuto').disabled = true;
            document.getElementById('timerInterval').disabled = false;
            document.getElementById('autoStatus').innerText = "Game paused.";
            document.getElementById('teacherDisplay').classList.remove('pulsing');
        }

        function addToHistory(elementId, num) {
            const container = document.getElementById(elementId);
            const span = document.createElement('span');
            span.className = 'history-item';
            span.innerText = num;
            container.appendChild(span);
            container.scrollTop = container.scrollHeight;
        }

        function openVerifyModal() {
            // Stop game if running
            if(teacherState.timerId) stopAutoRoll();
            
            const grid = document.getElementById('verifyGrid');
            grid.innerHTML = '';
            // Populate grid
            if(teacherState.history.length === 0) {
                grid.innerHTML = '<p>No numbers called yet.</p>';
            } else {
                teacherState.history.forEach(num => {
                    const item = document.createElement('div');
                    item.className = 'verify-item';
                    item.innerText = num;
                    grid.appendChild(item);
                });
            }
            document.getElementById('verifyModal').style.display = 'flex';
        }

        // ================= STUDENT PLAYER =================
        let mpState = { numbers: [], marked: new Set(), currentRoundNum: null, hasMarkedThisRound: true };

        function startStudentPlayer() {
            mpState.numbers = createBoardData();
            mpState.marked.clear();
            mpState.currentRoundNum = null;
            mpState.hasMarkedThisRound = true; 

            document.getElementById('studentHistory').innerHTML = '';
            document.getElementById('mpInput').value = '';
            document.getElementById('mpPassBtn').disabled = true;
            document.getElementById('mpFeedback').innerText = "Wait for Teacher's number.";
            
            const board = document.getElementById('mpBoard');
            board.innerHTML = '';
            mpState.numbers.forEach((num, idx) => {
                const cell = document.createElement('div');
                cell.className = 'cell locked'; 
                cell.id = `mp-cell-${idx}`;
                cell.innerText = num;
                cell.onclick = () => handleMpClick(idx, num, cell);
                board.appendChild(cell);
            });
            showView('studentView');
        }

        function mpConfirmNumber() {
            const input = document.getElementById('mpInput');
            const val = parseInt(input.value);
            if(isNaN(val) || val < 1 || val > 100) { alert("Please enter valid number"); return; }
            mpState.currentRoundNum = val;
            mpState.hasMarkedThisRound = false; 
            addToHistory('studentHistory', val);
            document.getElementById('mpFeedback').innerText = `Select ONE factor for ${val}`;
            document.getElementById('mpPassBtn').disabled = false; 
            document.querySelectorAll('#mpBoard .cell').forEach(c => {
                if(!c.classList.contains('marked')) c.classList.remove('locked');
            });
        }

        function mpPass() {
            if(mpState.currentRoundNum === null) return;
            mpState.hasMarkedThisRound = true;
            mpState.currentRoundNum = null;
            document.getElementById('mpFeedback').innerHTML = "<span style='color:var(--warning)'>Round Passed. Wait for next number.</span>";
            document.getElementById('mpPassBtn').disabled = true;
            document.getElementById('mpInput').value = '';
            document.getElementById('mpInput').focus();
            document.querySelectorAll('#mpBoard .cell').forEach(c => c.classList.add('locked'));
        }

        function handleMpClick(idx, val, el) {
            if(mpState.currentRoundNum === null) { alert("Confirm number first!"); return; }
            if(mpState.hasMarkedThisRound) { document.getElementById('mpFeedback').innerHTML = "<span style='color:var(--warning)'>One factor per round! Wait for next number.</span>"; return; }
            if(mpState.marked.has(idx)) return;

            if(mpState.currentRoundNum % val === 0) {
                mpState.marked.add(idx);
                el.classList.add('marked');
                mpState.hasMarkedThisRound = true; 
                mpState.currentRoundNum = null; 
                document.querySelectorAll('#mpBoard .cell').forEach(c => c.classList.add('locked'));
                document.getElementById('mpInput').value = '';
                document.getElementById('mpPassBtn').disabled = true;
                document.getElementById('mpFeedback').innerHTML = `<span style="color:green">Correct!</span> Wait for next number.`;
                if(checkWin(mpState.marked)) {
                    playWinSound(); // PLAY SOUND
                    document.getElementById('mpWinModal').style.display = 'flex';
                }
            } else {
                el.classList.add('wrong');
                document.getElementById('mpFeedback').innerHTML = `<span style="color:red">Oops!</span> ${val} is not a factor of ${mpState.currentRoundNum}`;
                setTimeout(() => el.classList.remove('wrong'), 500);
            }
        }
    </script>
</body>
</html>